<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Estoque de Materiais Headset</title>
  <meta name="theme-color" content="#6a53f2"/>

  <style>
    :root{
      --ink:#0f1431; --ink2:#6f76aa;
      --violet:#6a53f2; --accent:#22eacb; --pink:#ff5bb0;
      --panel:#fff; --stroke:#ece7ff;
      --shadow: 0 18px 48px rgba(106,83,242,.16), 0 8px 22px rgba(106,83,242,.10);
      --fs:100%;
    }
    *{box-sizing:border-box}
    html{font-size:var(--fs)}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      color:var(--ink); background:#faf8ff;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:14px;margin:18px 0 8px}
    .logo{width:58px;height:58px;border-radius:999px;object-fit:cover;box-shadow:0 8px 22px rgba(0,0,0,.08)}
    h1{
      margin:0 auto; text-align:center; width:100%;
      font-size:2.3rem; line-height:1.05; font-weight:800; letter-spacing:.2px;
      color:#1e2d90; text-shadow:0 6px 22px rgba(106,83,242,.35);
    }
    .zoom{position:sticky;top:8px;display:flex;gap:8px;justify-content:flex-end;margin:8px 0;z-index:2}
    .zbtn{
      font-size:1.0rem; padding:.45rem .65rem; border-radius:12px; background:#fff;
      color:#5a44e6; border:2px solid #cfc5ff; cursor:pointer; box-shadow:var(--shadow)
    }

    .panel{background:#fff;border:1px solid var(--stroke);border-radius:18px;padding:16px;margin:14px 0;box-shadow:var(--shadow)}
    .panel h2{margin:0 0 10px;text-align:center;color:#6a53f2;font-size:1.6rem}

    .card{background:#fff;border:1px solid #ececff;border-radius:16px;padding:14px;margin:10px 0;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .name{font-size:1.35rem;color:#242a66;font-weight:800}
    .code{font-size:1rem;color:#5b6aa6}
    .muted{font-size:.95rem;color:#7680b0;margin-top:4px}

    .tipo,.qty,.obs{
      border:1px solid #dcd7ff;border-radius:12px;background:#fff;
      padding:.55rem .7rem; font-size:1rem; box-shadow:0 6px 14px rgba(106,83,242,.10)
    }
    .qty{min-width:68px}
    .obs{min-width:16rem;flex:1}
    .btn{border:0;border-radius:12px;padding:.6rem .9rem;color:#fff;font-size:1rem;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .ok{background:linear-gradient(135deg,#7d89ff,#5d6bff)}
    .in{background:linear-gradient(135deg,var(--accent),#10bba1)}
    .out{background:linear-gradient(135deg,var(--pink),#ff2e63)}

    .badge{border-radius:999px;padding:.5rem .9rem;font-size:1rem;background:#f7f7ff;border:2px solid #dad6ff}
    .b-ok{border-color:#24b07a}.b-warn{border-color:#f5b942}.b-danger{border-color:#ff2e63}

    .center{display:flex;justify-content:center}
    .spinner{width:62px;height:62px;border-radius:999px;border:6px solid #9be; border-top-color:#6a53f2; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{margin:22px 0;text-align:center;color:#9aa2cc;font-size:.95rem}
    footer b{color:#303a87}

    /* limpa o banner azul do Apps Script quando abrimos direto lá */
    body > div[style*="rgb(232, 240, 254)"], body > div[style*="#e8f0fe"]{display:none !important;height:0 !important;overflow:hidden !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="./logo.png" alt="HeadSet Brasil"/>
      <h1>Estoque de Materiais Headset</h1>
      <div class="zoom">
        <button class="zbtn" onclick="ajustarFonte(-1)">A-</button>
        <button class="zbtn" onclick="ajustarFonte(1)">A+</button>
      </div>
    </header>

    <section class="panel">
      <h2>Produtos</h2>
      <div id="produtos" class="center"><div class="spinner" id="spin1"></div></div>
    </section>

    <section class="panel">
      <h2>Estoque Atual</h2>
      <div id="estoque" class="center"><div class="spinner" id="spin2"></div></div>
    </section>

    <footer>Desenvolvido por <b>Alexandre Cavalcante — HD TECH —</b></footer>
  </div>

<script>
  /* ==========================================================
     1) Cole aqui o SEU endpoint “echo” do Google que responde JSON
     Exemplo de formato: https://script.googleusercontent.com/macros/echo?user_content_key=...
     Esse mesmo BASE atende act=listar, act=movimentar, act=observacao
  ========================================================== */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzzTTeQTKKHsTfyAhzw-NDFqbto_aXGo-l6J-Rsp9eF/dev'; // <-- SUBSTITUA

  /* ============= UI utilitários ============= */
  const $ = sel => document.querySelector(sel);
  let _fs = Number(localStorage.getItem('eh_fs') || '100');
  document.documentElement.style.setProperty('--fs', _fs + '%');
  function ajustarFonte(step){
    _fs = Math.min(240, Math.max(70, _fs + step*10));
    document.documentElement.style.setProperty('--fs', _fs + '%');
    localStorage.setItem('eh_fs', String(_fs));
  }
  function classByLevel(estoque, minimo){
    estoque=Number(estoque||0); minimo=Number(minimo||0);
    if(minimo>0){
      if(estoque <= 0.25*minimo) return 'b-danger';
      if(estoque <  minimo)      return 'b-warn';
    }
    return 'b-ok';
  }

  /* ============= Renderização ============= */
  function productRow(it){
    const qtdOpts = Array.from({length:50}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
    return `
      <div class="card" id="cardL-${it.codigo}">
        <div class="row">
          <div>
            <div class="name">${it.nome}</div>
            <div class="code">Cód: ${it.codigo}</div>
            <div class="muted">Estoque: <b id="left-${it.codigo}">${it.estoque ?? 0}</b></div>
          </div>

          <div class="row">
            <select class="tipo" id="tipo-${it.codigo}">
              <option value="Unidade">Unidade</option>
              <option value="CX">CX</option>
              <option value="Litro">Litro</option>
            </select>
            <select class="qty" id="qty-${it.codigo}">${qtdOpts}</select>
            <input class="obs" id="obs-${it.codigo}" placeholder="Obs/Justificativa"/>
            <button class="btn ok" onclick="clickObs('${it.codigo}')">OK</button>
            <button class="btn in" onclick="clickMov('ENTRADA','${it.codigo}')">Entrada</button>
            <button class="btn out" onclick="clickMov('SAÍDA','${it.codigo}')">Saída</button>
          </div>
        </div>
      </div>`;
  }
  function stockRow(it){
    return `
      <div class="card" id="card-${it.codigo}">
        <div class="row">
          <div>
            <div class="name">${it.nome}</div>
            <div class="code">Cód: ${it.codigo}</div>
          </div>
          <div class="badge ${classByLevel(it.estoque, it.minimo)}" id="badge-${it.codigo}">
            Estoque: <span id="est-${it.codigo}">${it.estoque ?? 0}</span>
          </div>
        </div>
      </div>`;
  }
  function render(items){
    $('#produtos').innerHTML = items.map(productRow).join('') || '<div class="muted">Sem itens.</div>';
    $('#estoque').innerHTML  = items.map(stockRow).join('')  || '<div class="muted">Sem itens.</div>';
  }
  const findItem = cod => (window._items||[]).find(x=>x.codigo===cod);

  /* ============= API helper ============= */
  function url(params){
    // cache buster evita caches teimosos do GitHub/Safari
    const qs = new URLSearchParams(Object.assign({}, params, {_ts: Date.now()}));
    return `${API_BASE}&${qs.toString()}`;
  }
  async function apiListar(){
    const r = await fetch(url({act:'listar'}), {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('API indisponível');
    return r.json();
  }
  async function apiMovimentar(tipo, codigo, qtd, unidade, obs){
    const r = await fetch(url({act:'movimentar',tipo,codigo,qtd,unidade,obs}), {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('Falha ao movimentar');
    return r.json();
  }
  async function apiObservacao(codigo, obs){
    const r = await fetch(url({act:'observacao',codigo,obs}), {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('Falha ao salvar observação');
    return r.json();
  }

  /* ============= Ações dos botões ============= */
  async function clickMov(tipo, codigo){
    try{
      const qtdSel  = document.getElementById('qty-'+codigo);
      const tipoSel = document.getElementById('tipo-'+codigo);
      const obsInp  = document.getElementById('obs-'+codigo);

      const qtd     = Number(qtdSel?.value || 1);
      const unidade = String(tipoSel?.value || 'Unidade');
      const obs     = String(obsInp?.value || '');

      const res = await apiMovimentar(tipo, codigo, qtd, unidade, obs);
      const it = findItem(codigo);
      if (it){ it.estoque = res.estoque; }

      const l = document.getElementById('left-'+codigo);
      const e = document.getElementById('est-'+codigo);
      const b = document.getElementById('badge-'+codigo);
      if (l) l.textContent = res.estoque;
      if (e) e.textContent = res.estoque;
      if (b && it) b.className = 'badge ' + classByLevel(res.estoque, it.minimo||0);
    }catch(err){
      alert(err?.message || err);
    }
  }
  async function clickObs(codigo){
    const obsInp  = document.getElementById('obs-'+codigo);
    const obs     = String(obsInp?.value || '').trim();
    if (!obs){ alert('Escreva a observação antes de tocar em OK.'); return; }
    try{
      await apiObservacao(codigo, obs);
      obsInp.value = '';
      // feedback leve
      obsInp.placeholder = 'Observação salva!';
      setTimeout(()=>obsInp.placeholder='Obs/Justificativa', 1200);
    }catch(err){
      alert(err?.message || err);
    }
  }

  /* ============= Boot ============= */
  (async function init(){
    try{
      const items = await apiListar();
      window._items = (items||[]).map(x=>Object.assign({},x));
      render(window._items);
    }catch(err){
      $('#produtos').innerHTML = '';
      $('#estoque').innerHTML  = '';
      alert('Não foi possível carregar os produtos.\n' + (err?.message || err));
    }
  })();

  // expõe no escopo global (onclick dos botões)
  window.clickMov = clickMov;
  window.clickObs = clickObs;
  window.ajustarFonte = ajustarFonte;
</script>
</body>
</html>
